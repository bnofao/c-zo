---
github_number: 30
title: "Implement createMutations builder"
status: synced
type: task
priority: high
epic: 20
prd: kit
assignees: []
labels: [priority:high, module:kit, type:task]
created: 2026-02-04
updated: 2026-02-08
---

## Context
From TRD: kit
Section: 3.1 Repository - createMutations
Parent Feature: #21 (Repository)

## Technical Requirements

Implement the `createMutations` builder for write operations:

```typescript
export function createMutations<T, CreateInput, UpdateInput, TTable extends PgTable>(
  db: DrizzleDatabase,
  config: BaseConfig<TTable> & { cache?: CacheConfig }
)
```

### Methods to implement:
- `create(input: CreateInput): Promise<T>` - auto-generate id, version=1
- `createMany(inputs: CreateInput[]): Promise<T[]>` - batch insert
- `update(id, input & { expectedVersion }): Promise<T>` - optimistic locking
- `delete(id: string): Promise<{ success, deletedAt }>` - soft delete
- `hardDelete(id: string): Promise<boolean>` - permanent delete
- `restore(id: string): Promise<T>` - restore soft-deleted (conditional)

### Requirements:
- Auto-generate `id` using `generateId()`
- Set `version: 1` on create, increment on update
- Throw `OptimisticLockError` on version mismatch
- Throw `NotFoundError` when entity doesn't exist
- Invalidate cache on mutations (if cache configured)
- `restore` only available if `softDelete: true`

## Acceptance Criteria
- [ ] Implementation matches TRD specification
- [ ] All 6 mutation methods implemented
- [ ] Optimistic locking works correctly
- [ ] Error classes created (OptimisticLockError, NotFoundError)
- [ ] Cache invalidation on mutations
- [ ] Unit tests written
- [ ] Code reviewed

## Related
- TRD: docs/planning/kit/trd.md (Section 3.1)
- Epic: #20
- Parent: #21
