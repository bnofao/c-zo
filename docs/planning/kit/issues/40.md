---
github_number: 40
title: "Write integration tests for @czo/kit module"
status: synced
type: task
priority: medium
epic: 20
prd: kit
assignees: []
labels: []
created: 2026-02-04
updated: 2026-02-04
---

## Overview

Write integration tests that verify @czo/kit components work correctly with real infrastructure (PostgreSQL, Redis).

## Parent Epic

- Epic #20: @czo/kit Module

## Source Documents

- **TRD**: docs/planning/kit/trd.md (Section 5 Testing Strategy)

## Technical Details

### Test Environment

- PostgreSQL via Docker (docker-compose.test.yml)
- Redis via Docker
- Isolated test database per test run

### Integration Test Scenarios

#### Repository + Database
```typescript
describe('Repository Integration', () => {
  it('should perform full CRUD cycle', async () => {
    const repo = createRepository(db, { table: products })
    
    // Create
    const created = await repo.create({ name: 'Test' })
    expect(created.id).toBeDefined()
    
    // Read
    const found = await repo.findById(created.id)
    expect(found?.name).toBe('Test')
    
    // Update with optimistic locking
    const updated = await repo.update(created.id, { name: 'Updated' }, created.version)
    expect(updated.version).toBe(created.version + 1)
    
    // Soft delete
    await repo.delete(created.id)
    const deleted = await repo.findById(created.id)
    expect(deleted).toBeNull()
    
    // Still exists with includeDeleted
    const withDeleted = await repo.findById(created.id, { includeDeleted: true })
    expect(withDeleted?.deletedAt).toBeDefined()
  })
})
```

#### Cache + Redis
```typescript
describe('Cache Integration', () => {
  it('should cache and invalidate via Redis', async () => {
    const cache = useCacheManager('test')
    
    // Set via factory
    const value = await cache.getOrSet('key', () => 'computed', 60)
    expect(value).toBe('computed')
    
    // Should be cached
    const cached = await cache.getOrSet('key', () => 'new', 60)
    expect(cached).toBe('computed')
    
    // Invalidate
    await cache.delete('key')
    
    // Should recompute
    const recomputed = await cache.getOrSet('key', () => 'new', 60)
    expect(recomputed).toBe('new')
  })
})
```

#### Events + BullMQ
```typescript
describe('Events Integration', () => {
  it('should process async events via queue', async () => {
    const events = useEvents()
    const received: string[] = []
    
    events.on('test.event', (payload) => {
      received.push(payload.message)
    })
    
    await events.emitAsync('test.event', { message: 'hello' })
    
    // Wait for queue processing
    await new Promise(r => setTimeout(r, 100))
    
    expect(received).toContain('hello')
  })
})
```

### Test Commands

```bash
# Run integration tests
pnpm test:integration

# With Docker services
docker-compose -f docker-compose.test.yml up -d
pnpm test:integration
docker-compose -f docker-compose.test.yml down
```

## Acceptance Criteria

- [ ] docker-compose.test.yml created
- [ ] Database isolation per test
- [ ] Redis integration verified
- [ ] BullMQ queue processing verified
- [ ] Tests cleanup after themselves
- [ ] CI pipeline updated to run integration tests

## Dependencies

- Docker
- PostgreSQL
- Redis
- Unit tests completed
