---
github_number: 35
title: "Implement WebhookDispatcher with HMAC signing"
status: synced
type: task
priority: medium
epic: 20
prd: kit
assignees: []
labels: []
created: 2026-02-04
updated: 2026-02-04
---

## Overview

Implement the WebhookDispatcher for sending signed webhook events to installed apps with retry support.

## Parent Epic

- Epic #20: @czo/kit Module

## Source Documents

- **TRD**: docs/planning/kit/trd.md (Section 3.5.2 WebhookDispatcher)

## Technical Details

### Interface

```typescript
interface WebhookDispatcher {
  dispatch(event: string, payload: unknown, shopId: string): Promise<void>
  dispatchToApp(appId: string, event: string, payload: unknown): Promise<void>
}
```

### HMAC Signature

```typescript
function signPayload(payload: string, secret: string): string {
  return crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex')
}

// Header: X-CZO-Signature: sha256=<signature>
```

### Webhook Delivery

- Queue webhooks via BullMQ for reliability
- Retry with exponential backoff (3 attempts)
- Dead letter queue for failed webhooks
- Delivery status tracked in `webhook_deliveries` table

## Acceptance Criteria

- [ ] `dispatch()` sends to all subscribed apps for event
- [ ] `dispatchToApp()` sends to specific app
- [ ] HMAC signature in `X-CZO-Signature` header
- [ ] Retry with exponential backoff (1s, 4s, 16s)
- [ ] Dead letter queue after max retries
- [ ] Delivery status logging

## Dependencies

- BullMQ for queue
- Redis infrastructure
- AppRegistry (for subscription lookup)
