---
github_number: 44
title: "EventBus Abstraction avec Provider Pattern"
status: synced
type: feature
priority: high
epic: 43
prd: kit
assignees: []
labels: [type:feature, priority:high]
created: 2026-02-10
updated: 2026-02-10
---

## Context
From PRD: kit-microservices (Feature 1)
Priority: P0 — Phase 0 : Préparer le Monolithe
Epic: #43

## Description
Abstraction `EventBus` au-dessus du système d'events actuel, avec un provider pattern permettant de switcher entre le backend hookable (monolithe) et RabbitMQ (microservices) sans modifier le code des modules consommateurs.

## User Story
**As a** développeur de module
**I want to** publier des events de domaine via une API unifiée (`EventBus.publish()`)
**So that** mon code fonctionne identiquement en monolithe et en microservices

## Acceptance Criteria

### Interface `EventBus`
- [ ] `publish<K>(event, payload, metadata?)` : publie un event de domaine
- [ ] `subscribe(pattern, handler)` : s'abonne à un pattern d'events (ex: `product.item.*`)
- [ ] `shutdown()` : ferme les connexions proprement

### Provider `hookable` (backward compatible)
- [ ] Délègue à l'`EventEmitter` hookable existant
- [ ] Fonctionne sans configuration supplémentaire
- [ ] Aucune régression pour les modules existants

### Provider `rabbitmq` (futur microservices)
- [ ] `publish()` envoie via AMQP sur l'exchange `czo.events`
- [ ] `subscribe()` crée un consumer RabbitMQ avec binding pattern
- [ ] Configuration via `runtimeConfig.czo.rabbitmq`
- [ ] Gestion de la connexion (reconnexion automatique)

### Mode dual-write (transition)
- [ ] Émet simultanément sur hookable ET RabbitMQ
- [ ] Permet de valider que RabbitMQ reçoit les mêmes events
- [ ] Activable via config : `eventBus.dualWrite: true`

### Configuration
- [ ] Provider sélectionnable via `runtimeConfig.czo.eventBus.provider: 'hookable' | 'rabbitmq'`
- [ ] Fallback automatique sur hookable si RabbitMQ non configuré

### Tests
- [ ] Tests unitaires pour chaque provider
- [ ] Tests d'intégration pour le dual-write
- [ ] Couverture >= 80%

## File Structure
```
packages/kit/src/
  event-bus/
    types.ts           # EventBus, DomainEvent, EventBusProvider
    use-event-bus.ts   # useEventBus() runtime helper
    providers/
      hookable.ts      # createHookableEventBus()
      rabbitmq.ts      # createRabbitMQEventBus()
    index.ts           # Public API
```

## Dependencies
- hookable (existant)
- amqplib (nouveau, optional peer dependency)

## Related
- PRD: docs/planning/kit/prd-microservices.md
- TRD: docs/planning/kit/trd-microservices.md
- Epic: #43
