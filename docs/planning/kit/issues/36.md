---
github_number: 36
title: "Create database migration for apps tables"
status: synced
type: task
priority: medium
epic: 20
prd: kit
assignees: []
labels: []
created: 2026-02-04
updated: 2026-02-04
---

## Overview

Create database migration for the app system tables: installed_apps, app_tokens, and webhook_deliveries.

## Parent Epic

- Epic #20: @czo/kit Module

## Source Documents

- **TRD**: docs/planning/kit/trd.md (Section 3.5.3 Database Schema)

## Technical Details

### Tables

#### installed_apps
```sql
CREATE TABLE installed_apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id VARCHAR(255) NOT NULL,
  shop_id UUID NOT NULL REFERENCES shops(id),
  manifest JSONB NOT NULL,
  settings JSONB DEFAULT '{}',
  installed_at TIMESTAMPTZ DEFAULT NOW(),
  installed_by UUID NOT NULL REFERENCES users(id),
  UNIQUE(app_id, shop_id)
);
```

#### app_tokens
```sql
CREATE TABLE app_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  installed_app_id UUID NOT NULL REFERENCES installed_apps(id) ON DELETE CASCADE,
  token_hash VARCHAR(64) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ,
  revoked_at TIMESTAMPTZ
);
```

#### webhook_deliveries
```sql
CREATE TABLE webhook_deliveries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  installed_app_id UUID NOT NULL REFERENCES installed_apps(id),
  event VARCHAR(255) NOT NULL,
  payload JSONB NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  attempts INTEGER DEFAULT 0,
  last_attempt_at TIMESTAMPTZ,
  response_code INTEGER,
  response_body TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Indexes

```sql
CREATE INDEX idx_installed_apps_shop ON installed_apps(shop_id);
CREATE INDEX idx_app_tokens_app ON app_tokens(installed_app_id);
CREATE INDEX idx_webhook_deliveries_status ON webhook_deliveries(status, created_at);
```

## Acceptance Criteria

- [ ] Migration creates all three tables
- [ ] Foreign key constraints properly set
- [ ] Indexes created for common queries
- [ ] Migration is reversible (down migration)
- [ ] Drizzle schema types generated

## Dependencies

- Database setup
- Drizzle ORM
