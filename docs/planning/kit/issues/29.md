---
github_number: 29
title: "Implement createCachedQueries with Nitro cache"
status: synced
type: task
priority: high
epic: 20
prd: kit
assignees: []
labels: [priority:high, module:kit, type:task]
created: 2026-02-04
updated: 2026-02-08
---

## Context
From TRD: kit
Section: 3.1 Repository - createCachedQueries
Parent Feature: #21 (Repository), #22 (Cache)

## Technical Requirements

Implement `createCachedQueries` that wraps queries with Nitro's `defineCachedFunction`:

```typescript
import { defineCachedFunction } from 'nitropack/runtime'

export function createCachedQueries<T extends BaseEntity, TTable extends PgTable>(
  db: DrizzleDatabase,
  config: BaseConfig<TTable> & { cache: { prefix: string; ttl?: number } }
)
```

### Methods to implement:
- Wrap `findById` with `defineCachedFunction` (SWR enabled)
- Wrap `findByIds` with `defineCachedFunction`
- `invalidateCache(id: string)` - invalidate single entity cache
- `invalidateAllCache()` - invalidate all cache for this prefix

### Cache options:
- `maxAge`: configurable TTL (default 300s)
- `swr: true` - stale-while-revalidate
- `staleMaxAge`: TTL * 12
- `getKey`: custom key generation

## Acceptance Criteria
- [ ] Implementation matches TRD specification
- [ ] Uses Nitro's `defineCachedFunction`
- [ ] SWR is enabled by default
- [ ] Cache invalidation helpers work
- [ ] Unit tests written
- [ ] Code reviewed

## Related
- TRD: docs/planning/kit/trd.md (Section 3.1, 3.2)
- Epic: #20
- Parent: #21, #22
- Depends on: #28
